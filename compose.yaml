services:
  api:
    build: .
    container_name: hyvor-relay-api
    restart: always
    # FIX 1: Run the startup script (prevents 'relay not found' crash)
    command: ["sh", "/app/run"]
    # FIX 2: Explicitly disable healthchecks so Traefik allows traffic immediately
    healthcheck:
      disable: true
    environment:
      - APP_ENV=prod
      - 'APP_SECRET=${APP_SECRET}'
      - 'DATABASE_URL=${DATABASE_URL}'
      - 'WEB_URL=${WEB_URL}'
      - 'INSTANCE_DOMAIN=${INSTANCE_DOMAIN}'
      - 'OIDC_ISSUER_URL=${OIDC_ISSUER_URL}'
      - 'OIDC_CLIENT_ID=${OIDC_CLIENT_ID}'
      - 'OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}'
      # FIX 3: Force FrankenPHP to listen on HTTP Port 80
      - 'SERVER_NAME=:80'
      # FIX 4: Internal API communication
      - 'GO_SYMFONY_URL=http://127.0.0.1:80'
    networks:
      - hyvor-network
      - coolify

  worker:
    build: .
    container_name: hyvor-relay-worker
    # FIX 5: Point to the correct binary
    command:
      - /app/worker
    restart: always
    environment:
      - APP_ENV=prod
      - 'APP_SECRET=${APP_SECRET}'
      - 'DATABASE_URL=${DATABASE_URL}'
      - 'WEB_URL=${WEB_URL}'
      - 'INSTANCE_DOMAIN=${INSTANCE_DOMAIN}'
      - 'GO_SYMFONY_URL=http://hyvor-relay-api:80'
    networks:
      - hyvor-network

  simulator:
    image: 'hyvor/smtp-simulator:latest'
    container_name: hyvor-relay-simulator
    restart: unless-stopped
    environment:
      - DOMAIN=simulator.net
    networks:
      - hyvor-network

networks:
  hyvor-network:
    external: true
  coolify:
    external: true
