services:
  api:
    build: .
    container_name: hyvor-relay-api
    # REMOVED: command: ["relay", "api"]
    # REASON: The Dockerfile already defines the correct startup script (/app/run).
    # We must let the container use its default entrypoint.
    restart: always
    environment:
      - APP_ENV=prod
      - APP_SECRET=${APP_SECRET}
      - DATABASE_URL=${DATABASE_URL}
      - WEB_URL=${WEB_URL}
      - INSTANCE_DOMAIN=${INSTANCE_DOMAIN}
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
    networks:
      - hyvor-network
      - coolify

  worker:
    build: .
    container_name: hyvor-relay-worker
    # UPDATED: Point directly to the binary compiled by your Dockerfile
    command: ["/app/worker"]
    restart: always
    environment:
      - APP_ENV=prod
      - APP_SECRET=${APP_SECRET}
      - DATABASE_URL=${DATABASE_URL}
      - WEB_URL=${WEB_URL}
      - INSTANCE_DOMAIN=${INSTANCE_DOMAIN}
    networks:
      - hyvor-network

  simulator:
    image: hyvor/smtp-simulator:latest
    container_name: hyvor-relay-simulator
    restart: unless-stopped
    environment:
      - DOMAIN=simulator.net
    networks:
      - hyvor-network

networks:
  hyvor-network:
    external: true
  coolify:
    external: true
