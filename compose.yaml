services:
  # The main API and Frontend service
  api:
    image: hyvor/relay:latest
    container_name: hyvor-relay-api
    command: api
    restart: always
    environment:
      - APP_ENV=prod
      - APP_SECRET=${APP_SECRET}
      - DATABASE_URL=${DATABASE_URL}
      - WEB_URL=https://relay.apps.automato.ai
      - INSTANCE_DOMAIN=mail.relay.apps.automato.ai
      - OIDC_ISSUER_URL=https://github.com
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hyvor-relay.rule=Host(`relay.apps.automato.ai`)"
      - "traefik.http.routers.hyvor-relay.entrypoints=https"
      - "traefik.http.routers.hyvor-relay.tls=true"
      - "traefik.http.services.hyvor-relay.loadbalancer.server.port=80"
    networks:
      - hyvor-network

  # The Go-based worker for sending emails
  worker:
    image: hyvor/relay:latest
    container_name: hyvor-relay-worker
    command: worker
    restart: always
    environment:
      - APP_ENV=prod
      - APP_SECRET=${APP_SECRET}
      - DATABASE_URL=${DATABASE_URL}
      - WEB_URL=https://relay.apps.automato.ai
      - INSTANCE_DOMAIN=mail.relay.apps.automato.ai
    networks:
      - hyvor-network

  # Your SMTP simulator for testing
  simulator:
    image: hyvor/smtp-simulator:latest
    container_name: hyvor-relay-simulator
    restart: unless-stopped
    environment:
      - DOMAIN=simulator.net
    networks:
      - hyvor-network

networks:
  hyvor-network:
    external: true
